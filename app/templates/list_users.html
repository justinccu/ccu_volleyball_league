<!DOCTYPE html>
<html>

<head>
    <title>ä½¿ç”¨è€…æ¸…å–®</title>
    <script>
        function toggleTeamInputs() {
            var role = document.getElementById("role").value;
            document.getElementById("new_team_section").style.display = role === "captain" ? "block" : "none";
            document.getElementById("select_team_section").style.display = role === "member" ? "block" : "none";
        }
        window.onload = toggleTeamInputs;
    </script>
    <style>
        .flash-message {
            margin-top: 20px;
        }
        .text-red {
            color: red;
            font-weight: bold;
        }
        .text-green {
            color: green;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <h2>æ–°å¢ä½¿ç”¨è€…</h2>

    <form method="POST">
        <label>å§“åï¼š</label>
        <input type="text" name="name" required>

        <label>å¸³è™Ÿï¼š</label>
        <input type="text" name="username" required>

        <label>å¯†ç¢¼ï¼š</label>
        <input type="password" name="password" required>

        <label>è§’è‰²ï¼š</label>
        <select name="role" id="role" onchange="toggleTeamInputs()" required>
            <option value="captain">captain</option>
            <option value="member">member</option>
            <option value="visitor">visitor</option>
            <option value="admin">admin</option>
        </select>

        <br>
        <label>ç³»ç´šï¼š</label>
        <select name="department" required>
            {% for dep in departments %}
            <option value="{{ dep }}">{{ dep }}</option>
            {% endfor %}
        </select>

        <label>å¹´ç´šï¼š</label>
        <select name="grade" required>
            {% for i in range(1, 7) %}
            <option value="{{ i }}">{{ i }} å¹´ç´š</option>
            {% endfor %}
        </select>

        <label>æ€§åˆ¥ï¼š</label>
        <select name="gender" required>
            <option value="ç”·">ç”·</option>
            <option value="å¥³">å¥³</option>
        </select>

        <!-- éšŠé•·è¼¸å…¥éšŠå -->
        <!-- éšŠé•·è¼¸å…¥éšŠåèˆ‡é¡åˆ¥ -->
        <div id="new_team_section" style="margin-top: 5px;">
            <label>æ–°éšŠä¼åç¨±ï¼š</label>
            <input type="text" name="new_team_name">

            <label>éšŠä¼é¡åˆ¥ï¼š</label>
            <select name="team_type">
                <option value="ç”·æ’">ç”·æ’</option>
                <option value="å¥³æ’">å¥³æ’</option>
            </select>
        </div>

        <!-- éšŠå“¡é¸æ“‡éšŠä¼ -->
        <div id="select_team_section" style="margin-top: 5px; display:none;">
            <label>é¸æ“‡åŠ å…¥éšŠä¼ï¼š</label>
            <select name="team_id">
                {% for team in teams %}
                <option value="{{ team.id }}">{{ team.name }}({{team.team_type}})</option>
                {% endfor %}
            </select>
        </div>

        <br>
        <button type="submit">å»ºç«‹ä½¿ç”¨è€…</button>
    </form>

    <hr>
    <h2>åˆ†ç™¼ä½¿ç”¨è€…</h2>

    <form method="POST" action="{{ url_for('route_ManageUser.assign_user') }}">
        <label>é¸æ“‡ä½¿ç”¨è€…ï¼š</label>
        <select name="user_id" required>
            {% for u in users %}
            {% if u.role != 'admin' and u.role != 'captain' %}
            <option value="{{ u.id }}">{{ u.name }}--{{u.username}}({{ u.team.name if u.team else 'ç„¡éšŠä¼' }})</option>
            {% endif %}
            {% endfor %}
        </select>

        <label>åˆ†é…è‡³éšŠä¼ï¼š</label>
        <select name="team_id">
            {% for team in teams %}
            <option value="{{ team.id }}">{{ team.name }}</option>
            {% endfor %}
            <option value="">ç„¡</option>
        </select>

        <button type="submit">åˆ†é…</button>
    </form>

    <hr>
    <h2>åˆªé™¤éšŠä¼</h2>

    <form method="POST" action="{{ url_for('route_ManageUser.delete_team', team_id=0) }}"
        onsubmit="return confirmDeleteTeam()">
        <label>éšŠä¼é¡å‹ï¼š</label>
        <select id="team-type" onchange="filterTeams()" required>
            <option value="ç”·æ’" selected>ç”·æ’</option>
            <option value="å¥³æ’">å¥³æ’</option>
        </select>

        <label>é¸æ“‡è¦åˆªé™¤çš„éšŠä¼ï¼š</label>
        <select name="team_id" id="team-select" required>
            <option value="">-- è«‹é¸æ“‡éšŠä¼ --</option>
            {% for team in teams %}
            <option value="{{ team.id }}" data-type="{{ team.team_type }}">{{ team.name }}</option>
            {% endfor %}
        </select>

        <button type="submit">åˆªé™¤æ•´éšŠ</button>
    </form>

    <script>
        function filterTeams() {
            const selectedType = document.getElementById('team-type').value;
            const teamSelect = document.getElementById('team-select');
            let firstVisibleOptionSet = false;

            for (const option of teamSelect.options) {
                if (option.value === "") {
                    option.hidden = false;
                    option.disabled = false;
                    continue;
                }
                const isVisible = option.getAttribute('data-type') === selectedType;
                option.hidden = !isVisible;
                option.disabled = !isVisible;

                if (isVisible && !firstVisibleOptionSet) {
                    teamSelect.value = option.value;
                    firstVisibleOptionSet = true;
                }
            }

            if (!firstVisibleOptionSet) {
                teamSelect.value = ""; // è‹¥ç„¡éšŠä¼å‰‡æ¸…ç©ºé¸æ“‡
            }
        }

        function confirmDeleteTeam() {
            const teamSelect = document.getElementById('team-select');
            const selectedText = teamSelect.options[teamSelect.selectedIndex]?.text || '';
            return confirm(`ç¢ºå®šè¦åˆªé™¤éšŠä¼ "${selectedText}" å—ï¼Ÿ`);
        }

        // åˆå§‹åŸ·è¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            filterTeams(); // é è¨­é¡¯ç¤ºç”·æ’éšŠä¼ä¸¦è‡ªå‹•é¸æ“‡ç¬¬ä¸€å€‹
        });
    </script>

    <script>
        function confirmDeleteTeam() {
            const select = document.getElementById("team-select");
            if (select.value === "") {
                alert("è«‹å…ˆé¸æ“‡éšŠä¼");
                return false;
            }
            return confirm("ç¢ºå®šè¦åˆªé™¤æ­¤éšŠä¼å—ï¼Ÿæ­¤æ“ä½œæœƒè§£é™¤æ‰€æœ‰æˆå“¡èˆ‡éšŠä¼çš„é—œè¯ï¼");
        }

        // æŠŠ action çš„ URL å‹•æ…‹è£œä¸ŠéšŠä¼ ID
        document.getElementById("team-select").addEventListener("change", function () {
            const form = this.closest("form");
            const selectedId = this.value;
            form.action = "/admin/delete_team/" + selectedId;
        });
    </script>
    <hr>

    <h2>ä½¿ç”¨è€…æ¸…å–®</h2>
    <form method="get" style="margin-bottom: 16px;">
        <label>éšŠä¼é¡å‹ï¼š</label>
        <select name="team_type" onchange="this.form.submit()">
            <option value="">å…¨éƒ¨</option>
            <option value="ç”·æ’" {% if request.args.get('team_type') == 'ç”·æ’' %}selected{% endif %}>ç”·æ’</option>
            <option value="å¥³æ’" {% if request.args.get('team_type') == 'å¥³æ’' %}selected{% endif %}>å¥³æ’</option>
        </select>
    
        <label style="margin-left: 10px;">æ‰€å±¬éšŠä¼ï¼š</label>
        <select name="team_id" onchange="this.form.submit()">
            <option value="">å…¨éƒ¨</option>
            {% for t in teams if not request.args.get('team_type') or t.team_type == request.args.get('team_type') %}
            <option value="{{ t.id }}" {% if request.args.get('team_id') == t.id|string %}selected{% endif %}>{{ t.name }}({{ t.team_type }})</option>
            {% endfor %}
        </select>
        <noscript><button type="submit">ç¯©é¸</button></noscript>
    </form>
    <table border="1">
        <tr>
            <th>ID</th>
            <th>å§“å</th>
            <th>å¸³è™Ÿ</th>
            <th>è§’è‰²</th>
            <th>æ‰€å±¬éšŠä¼</th>
            <th>ç³»ç´š</th>
            <th>å¹´ç´š</th>
            <th>æ€§åˆ¥</th>
            <th>æ“ä½œ</th>
        </tr>
        {% for u in users %}
        <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.name }}</td>
            <td>{{ u.username }}</td>
            <td>{{ u.role }}</td>
            <td>
                {% if u.team %}
                {{ u.team.name }}({{ u.team.team_type }})
                {% else %}
                ç„¡
                {% endif %}
            </td>
            <td>{{ u.department or 'â€”' }}</td>
            <td>{{ u.grade or 'â€”' }}</td>
            <td>{{ u.gender or 'â€”' }}</td>
            <td>
                {% if u.role == 'admin' %}
                ç®¡ç†å“¡
                {% elif u.role == 'captain' %}
                éšŠé•·
                {% else %}
                <form method="POST" action="{{ url_for('route_ManageUser.delete_user', user_id=u.id) }}"
                    style="display:inline;">
                    <button type="submit" onclick="return confirm('ç¢ºå®šè¦åˆªé™¤ {{ u.username }} å—ï¼Ÿ')">ğŸ—‘ åˆªé™¤</button>
                </form>
                {% endif %}
            </td>
        </tr>
        {% endfor %}
    </table>

    <br>
    <hr><br>


    <br><a href="/dashboard">å›ä¸»é </a>
</body>

</html>