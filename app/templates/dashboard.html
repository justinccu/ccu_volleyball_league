<!DOCTYPE html>
<html>
<head>
    <title>ä¸»é </title>
    <style>
        .flash-message {
            margin-top: 20px;
        }
        .text-red {
            color: red;
            font-weight: bold;
        }
        .text-green {
            color: green;
            font-weight: bold;
        }
        .schedule-table {
            width: 50%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .schedule-table th, .schedule-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .schedule-table th {
            background-color: #f5f5f5;
        }
        .schedule-table tr:hover {
            background-color: #f9f9f9;
            cursor: pointer;
        }
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-button:hover {
            color: black;
        }
        .edit-button {
            background-color: #4CAF50;
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .edit-button:hover {
            background-color: #45a049;
        }
        /* Filter styles */
        .filter-section {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .filter-group {
            margin-bottom: 10px;
        }
        .filter-group label {
            margin-right: 10px;
            font-weight: bold;
        }
        .filter-group select {
            padding: 5px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .filter-buttons {
            margin-top: 10px;
        }
        .filter-buttons button {
            padding: 5px 15px;
            margin-right: 10px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: #fff;
            cursor: pointer;
        }
        .filter-buttons button:hover {
            background-color: #f0f0f0;
        }
        .filter-buttons button.active {
            background-color: #007bff;
            color: white;
            border-color: #0056b3;
        }
    </style>
</head>
<body>
    <h1>ğŸ æ’çƒè¯è³½ç³»çµ±</h1>

    <h2>æ­¡è¿, {{ current_user.name }}!</h2>
    <p>é€™è£¡å°‡é¡¯ç¤ºä½ çš„æ¯”è³½èˆ‡å¸³è™Ÿç®¡ç†åŠŸèƒ½</p>

    <!-- è³½ç¨‹è¡¨éƒ¨åˆ† -->
    <h3>ğŸ“… è³½ç¨‹è¡¨</h3>
    
    <!-- ç¯©é¸æ§åˆ¶é … -->
    <div class="filter-section">
        <div class="filter-group">
            <label>æ¯”è³½é¡å‹ï¼š</label>
            <select id="teamTypeFilter">
                <option value="all">å…¨éƒ¨</option>
                <option value="ç”·æ’">ç”·æ’</option>
                <option value="å¥³æ’">å¥³æ’</option>
            </select>
        </div>
        <div class="filter-group">
            <label>éšŠä¼ï¼š</label>
            <select id="teamFilter">
                <option value="all">å…¨éƒ¨éšŠä¼</option>
            </select>
        </div>
        <div class="filter-group">
            <label>ç‹€æ…‹ï¼š</label>
            <select id="statusFilter">
                <option value="all">å…¨éƒ¨ç‹€æ…‹</option>
                <option value="å°šæœªé–‹å§‹">å°šæœªé–‹å§‹</option>
                <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
                <option value="å·²çµæŸ">å·²çµæŸ</option>
            </select>
        </div>
        <div class="filter-buttons">
            <button onclick="applyFilters()">å¥—ç”¨ç¯©é¸</button>
            <button onclick="resetFilters()">é‡ç½®ç¯©é¸</button>
        </div>
    </div>

    <table class="schedule-table">
        <thead>
            <tr>
                <th>æ¯”è³½æ™‚é–“</th>
                <th>é¡å‹</th>
                <th>éšŠä¼1</th>
                <th>éšŠä¼2</th>
                <th>ç‹€æ…‹</th>
                {% if current_user.role == 'admin' %}
                <th>æ“ä½œ</th>
                {% endif %}
            </tr>
        </thead>
        <tbody id="scheduleTableBody">
            <!-- å‹•æ…‹å¡«å……å…§å®¹ -->
        </tbody>
    </table>

    <!-- Modal -->
    <div id="matchModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <div class="modal-header">
                <h3>æ¯”è³½è©³ç´°è³‡è¨Š</h3>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- å‹•æ…‹å¡«å……å…§å®¹ -->
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯æ¯”è³½è³‡è¨Šçš„ Modal -->
    <div id="editMatchModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeEditModal()">&times;</span>
            <h3>ç·¨è¼¯æ¯”è³½è³‡è¨Š</h3>
            <form id="editMatchForm">
                <input type="hidden" id="editMatchId">
                <div>
                    <label>æ¯”è³½æœŸé–“ï¼š</label>
                    <span id="matchPeriod"></span>
                    <br>
                    <small style="color: #666;">ï¼ˆå«å…©é€±èª¿æ•´ç·©è¡æœŸï¼‰</small>
                </div>
                <div>
                    <label>æ¯”è³½æ™‚é–“ï¼š</label>
                    <select id="editMatchTime">
                        <option value="">è«‹é¸æ“‡æ™‚é–“</option>
                    </select>
                </div>
                <div>
                    <label>ç¬¬ä¸€å±€æ¯”åˆ†ï¼š</label>
                    <input type="number" id="editTeam1Set1"> : 
                    <input type="number" id="editTeam2Set1">
                </div>
                <div>
                    <label>ç¬¬äºŒå±€æ¯”åˆ†ï¼š</label>
                    <input type="number" id="editTeam1Set2"> : 
                    <input type="number" id="editTeam2Set2">
                </div>
                <div>
                    <label>ç¬¬ä¸‰å±€æ¯”åˆ†ï¼š</label>
                    <input type="number" id="editTeam1Set3"> : 
                    <input type="number" id="editTeam2Set3">
                </div>
                <div>
                    <label>ç‡ˆéŒ¢(ä¸»éšŠ)ï¼š</label>
                    <input type="number" id="editTeam1LampFee">
                </div>
                <div>
                    <label>ç‡ˆéŒ¢(å®¢éšŠ)ï¼š</label>
                    <input type="number" id="editTeam2LampFee">
                </div>
                <div>
                    <label>ç‹€æ…‹ï¼š</label>
                    <select id="editMatchStatus" required>
                        <option value="pending">å°šæœªé–‹å§‹</option>
                        <option value="waiting_confirm">ç­‰å¾…ç¢ºèª</option>
                        <option value="confirmed">å·²ç¢ºèª</option>
                        <option value="rejected">å·²æ‹’çµ•</option>
                    </select>
                </div>
                <div style="margin-top: 20px; text-align: right;">
                    <button type="button" onclick="closeEditModal()" style="margin-right: 10px; padding: 5px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer;">å–æ¶ˆ</button>
                    <button type="submit" class="edit-button">ä¿å­˜ä¿®æ”¹</button>
                </div>
            </form>
        </div>
    </div>

    {% if current_user.role == 'admin' %}
        <h3>âš™ï¸ ç®¡ç†å“¡æ“ä½œé¢æ¿</h3>
        <ul>
            <li><a href="/admin/users">ğŸ‘¥ ä½¿ç”¨è€…ç®¡ç†</a></li>
            <li><a href="/admin/draw_teams">ğŸ² åˆ†çµ„æŠ½ç±¤</a></li>
            <li><a href="/team/list">ğŸ éšŠä¼æˆå“¡æŸ¥è©¢</a></li>
        </ul>
    {% endif %}

    {% if current_user.role in ['captain', 'member'] %}
        <h3>ğŸ“… æˆ‘çš„æ¯”è³½</h3>
        <a href="/my/matches"><button>æŸ¥çœ‹æˆ‘çš„æ¯”è³½</button></a>

        <h3>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ æˆ‘çš„éšŠä¼æˆå“¡</h3>
        <a href="/my/team_members"><button>æŸ¥çœ‹æˆå“¡åˆ—è¡¨</button></a>
    {% endif %}

    {% if current_user.role == 'captain' %}
        <h3>ğŸ“ å…¥éšŠç”³è«‹å¯©æ ¸</h3>
        <a href="/captain/requests"><button>æŸ¥çœ‹å¾…å¯©æ ¸ç”³è«‹</button></a>

        <h3>ğŸ¯ è£åˆ¤ç™»éŒ„æ¯”è³½çµæœ</h3>
        <a href="/referee/matches"><button>æˆ‘è¦ç™»éŒ„æˆç¸¾</button></a>
    {% endif %}

    {% if current_user.role == 'visitor' %}
        <h3>ğŸ“¨ åŠ å…¥éšŠä¼</h3>
        <a href="/join/request"><button>ç”³è«‹åŠ å…¥éšŠä¼</button></a>
    {% endif %}

    <br><br>
    <a href="/logout">ç™»å‡º</a>

    <script>
        // ç²å– modal å…ƒç´ 
        const modal = document.getElementById('matchModal');
        const modalContent = document.getElementById('modalContent');
        const closeButton = document.getElementsByClassName('close-button')[0];
        let allMatches = []; // å­˜å„²æ‰€æœ‰æ¯”è³½æ•¸æ“š

        // é—œé–‰ modal çš„å‡½æ•¸
        function closeModal() {
            modal.style.display = 'none';
        }

        // é»æ“Šé—œé–‰æŒ‰éˆ•æ™‚é—œé–‰ modal
        closeButton.onclick = closeModal;

        // é»æ“Š modal å¤–éƒ¨æ™‚é—œé–‰ modal
        window.onclick = function(event) {
            if (event.target == modal) {
                closeModal();
            }
        }

        // æ›´æ–°éšŠä¼é¸é …
        function updateTeamOptions(matches) {
            const teamFilter = document.getElementById('teamFilter');
            const teams = new Set();
            
            matches.forEach(match => {
                teams.add(match.home_team);
                teams.add(match.away_team);
            });
            
            // æ¸…ç©ºç¾æœ‰é¸é …ï¼ˆä¿ç•™"å…¨éƒ¨éšŠä¼"é¸é …ï¼‰
            while (teamFilter.options.length > 1) {
                teamFilter.remove(1);
            }
            
            // æ·»åŠ éšŠä¼é¸é …
            Array.from(teams).sort().forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamFilter.appendChild(option);
            });
        }

        // å¥—ç”¨ç¯©é¸
        function applyFilters() {
            const teamType = document.getElementById('teamTypeFilter').value;
            const team = document.getElementById('teamFilter').value;
            const status = document.getElementById('statusFilter').value;
            
            const filteredMatches = allMatches.filter(match => {
                const matchTeamType = teamType === 'all' || match.team_type === teamType;
                const matchTeam = team === 'all' || match.home_team === team || match.away_team === team;
                const matchStatus = status === 'all' || match.status === status;
                
                return matchTeamType && matchTeam && matchStatus;
            });
            
            displayMatches(filteredMatches);
        }

        // é‡ç½®ç¯©é¸
        function resetFilters() {
            document.getElementById('teamTypeFilter').value = 'all';
            document.getElementById('teamFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            displayMatches(allMatches);
        }

        // é¡¯ç¤ºæ¯”è³½åˆ—è¡¨
        function displayMatches(matches) {
            const tbody = document.getElementById('scheduleTableBody');
            tbody.innerHTML = '';
            
            matches.forEach(match => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${match.time}</td>
                    <td>${match.team_type}</td>
                    <td>${match.home_team}</td>
                    <td>${match.away_team}</td>
                    <td>${match.status}</td>
                    {% if current_user.role == 'admin' %}
                    <td>
                        <button class="edit-button" onclick="openEditModal(${match.id})">ç·¨è¼¯</button>
                    </td>
                    {% endif %}
                `;
                
                row.addEventListener('click', () => showMatchDetails(match));
                tbody.appendChild(row);
            });
        }

        // æ›´æ–°è³½ç¨‹è¡¨çš„å‡½æ•¸
        function updateSchedule() {
            fetch('/api/matches')
                .then(response => response.json())
                .then(data => {
                    allMatches = data; // ä¿å­˜æ‰€æœ‰æ¯”è³½æ•¸æ“š
                    updateTeamOptions(data); // æ›´æ–°éšŠä¼é¸é …
                    displayMatches(data); // é¡¯ç¤ºæ‰€æœ‰æ¯”è³½
                })
                .catch(error => console.error('Error fetching matches:', error));
        }

        // é¡¯ç¤ºæ¯”è³½è©³ç´°è³‡è¨Šçš„å‡½æ•¸
        function showMatchDetails(match) {
            modalContent.innerHTML = `
                <p><strong>æ¯”è³½æ™‚é–“ï¼š</strong>${match.time}</p>
                <p><strong>æ¯”è³½é¡å‹ï¼š</strong>${match.team_type}</p>
                <p><strong>éšŠä¼1ï¼š</strong>${match.home_team}</p>
                <p><strong>éšŠä¼2ï¼š</strong>${match.away_team}</p>
                <p><strong>æ¯”åˆ†ï¼š</strong>${match.score || 'å°šæœªé–‹å§‹'}</p>
                <p><strong>è£åˆ¤ï¼š</strong>${match.referee || 'å¾…å®š'}</p>
            `;
            modal.style.display = 'block';
        }

        // é—œé–‰ç·¨è¼¯ Modal
        function closeEditModal() {
            document.getElementById('editMatchModal').style.display = 'none';
            // é‡ç½®è¡¨å–®
            document.getElementById('editMatchForm').reset();
        }

        // æ‰“é–‹ç·¨è¼¯ Modal
        function openEditModal(matchId) {
            // å…ˆç²å–å¯ç”¨æ™‚é–“
            fetch(`/api/available_times/${matchId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // é¡¯ç¤ºæ¯”è³½æœŸé–“
                        const periodElement = document.getElementById('matchPeriod');
                        periodElement.innerHTML = `${data.period.start} è‡³ ${data.period.end}<br>` +
                            `<small style="color: #666;">ï¼ˆåŸå§‹çµæŸæ—¥æœŸï¼š${data.period.original_end}ï¼‰</small>`;

                        const timeSelect = document.getElementById('editMatchTime');
                        timeSelect.innerHTML = '<option value="">è«‹é¸æ“‡æ™‚é–“</option>';
                        
                        data.available_times.forEach(time => {
                            const option = document.createElement('option');
                            option.value = time;
                            option.textContent = new Date(time).toLocaleString('zh-TW', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            });
                            timeSelect.appendChild(option);
                        });
                    } else {
                        alert('ç„¡æ³•ç²å–å¯ç”¨æ™‚é–“ï¼š' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching available times:', error);
                    alert('ç²å–å¯ç”¨æ™‚é–“æ™‚ç™¼ç”ŸéŒ¯èª¤');
                });

            // ç²å–æ¯”è³½è³‡è¨Š
            fetch(`/api/match/${matchId}`)
                .then(response => response.json())
                .then(match => {
                    document.getElementById('editMatchId').value = match.id;
                    if (match.time) {
                        const timeSelect = document.getElementById('editMatchTime');
                        const currentTime = match.time.replace(' ', 'T');
                        // å¦‚æœç•¶å‰æ™‚é–“ä¸åœ¨é¸é …ä¸­ï¼Œæ·»åŠ å®ƒ
                        if (!Array.from(timeSelect.options).some(option => option.value === currentTime)) {
                            const option = document.createElement('option');
                            option.value = currentTime;
                            option.textContent = new Date(currentTime).toLocaleString('zh-TW', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit',
                                hour: '2-digit',
                                minute: '2-digit',
                                hour12: false
                            });
                            timeSelect.appendChild(option);
                        }
                        timeSelect.value = currentTime;
                    }
                    document.getElementById('editTeam1Set1').value = match.team1_set1 || '';
                    document.getElementById('editTeam2Set1').value = match.team2_set1 || '';
                    document.getElementById('editTeam1Set2').value = match.team1_set2 || '';
                    document.getElementById('editTeam2Set2').value = match.team2_set2 || '';
                    document.getElementById('editTeam1Set3').value = match.team1_set3 || '';
                    document.getElementById('editTeam2Set3').value = match.team2_set3 || '';
                    document.getElementById('editTeam1LampFee').value = match.team1_lamp_fee || '';
                    document.getElementById('editTeam2LampFee').value = match.team2_lamp_fee || '';
                    document.getElementById('editMatchStatus').value = match.status;
                    
                    document.getElementById('editMatchModal').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error fetching match details:', error);
                    alert('ç²å–æ¯”è³½è³‡è¨Šæ™‚ç™¼ç”ŸéŒ¯èª¤');
                });
        }

        // æäº¤ç·¨è¼¯è¡¨å–®
        document.getElementById('editMatchForm').onsubmit = function(e) {
            e.preventDefault();
            
            const matchId = document.getElementById('editMatchId').value;
            const formData = {};

            // åªæ·»åŠ æœ‰å€¼çš„æ¬„ä½
            const matchTime = document.getElementById('editMatchTime').value;
            if (matchTime) formData.match_time = matchTime;

            const team1Set1 = document.getElementById('editTeam1Set1').value;
            if (team1Set1) formData.team1_set1 = team1Set1;

            const team2Set1 = document.getElementById('editTeam2Set1').value;
            if (team2Set1) formData.team2_set1 = team2Set1;

            const team1Set2 = document.getElementById('editTeam1Set2').value;
            if (team1Set2) formData.team1_set2 = team1Set2;

            const team2Set2 = document.getElementById('editTeam2Set2').value;
            if (team2Set2) formData.team2_set2 = team2Set2;

            const team1Set3 = document.getElementById('editTeam1Set3').value;
            if (team1Set3) formData.team1_set3 = team1Set3;

            const team2Set3 = document.getElementById('editTeam2Set3').value;
            if (team2Set3) formData.team2_set3 = team2Set3;

            const team1LampFee = document.getElementById('editTeam1LampFee').value;
            if (team1LampFee) formData.team1_lamp_fee = team1LampFee;

            const team2LampFee = document.getElementById('editTeam2LampFee').value;
            if (team2LampFee) formData.team2_lamp_fee = team2LampFee;

            const status = document.getElementById('editMatchStatus').value;
            if (status) formData.status = status;

            fetch(`/api/match/${matchId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('ä¿®æ”¹æˆåŠŸï¼');
                    document.getElementById('editMatchModal').style.display = 'none';
                    updateSchedule();
                } else {
                    alert('ä¿®æ”¹å¤±æ•—ï¼š' + data.message);
                }
            });
        };

        // åˆå§‹è¼‰å…¥è³½ç¨‹è¡¨
        updateSchedule();

        // æ¯30ç§’æ›´æ–°ä¸€æ¬¡è³½ç¨‹è¡¨
        setInterval(updateSchedule, 30000);
    </script>
</body>
</html>